<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<style>
body{
  display: table;
  margin: auto;
  text-align:center;
}
</style>
</head>

<body>
  <h2>Kingdom</h2>
  <div id="container">
<table>
  <thead>
    <tr>
      <th class="firstName">
        <a href="#" class="sort">Name</a>
      </th>
      <th class="lastName">Surname</th>
      <th>Date of Birth</th>
      <th class="function">Work as</th>
      <th>Experience</th>
    </tr>
    <tr>
      <th class="firstName">
        <input class="filter" type="text"/>
      </th>
      <th class="lastName">
        <input class="filter" type="text"/>
      </th>
      <th></th>
      <th class="function">
        <input class="filter" type="text"/>
      </th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

  </div>
  <div class="paging">
    <a href="#" class="previous">Previous</a>
    <a href="#" class="next">Next</a>
  </div>

<script>

var records = [];
var filteredRecords = []; //=records (bez filtracji)
var sortKey = 'firstName';
var page = 1;
var rowsOnPage = 5;

var filter = {};

function getPage(records) {
  var first = (page - 1) * rowsOnPage;
  return records.slice(first, first + rowsOnPage); // wyswietlanie 0-4, 5-9 10-14
}

function renderTable() { //pojedyncze renderowanie tablicy

  var recordsToDisplay = getPage(filteredRecords);//funkcja getPage wybiera rekordy do wy≈õwietlenia

  var table = '';
  for (x in recordsToDisplay) {
      var record = recordsToDisplay[x];
      table += "<tr><td>" +  record.firstName + "<td>" + record.lastName +"<td>" + record.dateOfBirth
      + "<td>" + record.function + "<td>" + record.experience + "</td></tr>";
  };
  $('#container tbody').html(table);//  wrzucam inner html
}


function sortByString(a, b){ //sortujemy w srodku records(json)
  return ((a[sortKey] < b[sortKey]) ? -1 : ((a[sortKey] > b[sortKey]) ? 1:0));
}

$('th.firstName .sort').click(function() {
  sortKey = 'firstName';
  records.sort(sortByString);
  renderTable();
});

$('th.lastName').click(function() {
  sortKey = 'lastName';
  records.sort(sortByString);
  renderTable();
});

$('th.function').click(function() {
  sortKey = 'function';
  records.sort(sortByString);
  renderTable();
});

$('.paging .previous').click(function() {
  if (page>1){
    page -= 1;
    renderTable();
  }
});

$('.paging .next').click(function() {
  var numberOfPages = Math.trunc((filteredRecords.length - 1) / rowsOnPage + 1);//wylicza mi liczbe stron
  if (page < numberOfPages){
    page += 1;
    renderTable();
  }
});

$('th.firstName .filter').change(function() {
  filter.firstName = $(this).val(); //val zwraca nam aktualny input
  filterTable();
});

$('th.lastName .filter').change(function() {
  filter.lastName = $(this).val(); //val zwraca nam aktualny input
  filterTable();
});

$('th.function .filter').change(function() {
  filter.function = $(this).val(); //val zwraca nam aktualny input
  filterTable();
});

function stringFilter(value, filterValue) {
  if (!filterValue) { //sprawdza czy podana wartosc formularza
    return true;
  } else {
    return value.toLowerCase().lastIndexOf(filterValue.toLowerCase(), 0) === 0; // https://www.w3schools.com/JSREF/jsref_lastindexof.asp
  }
}

function filterTable() {
  filteredRecords = records.filter(function(r) {
    return stringFilter(r.firstName, filter.firstName) &&
            stringFilter(r.lastName, filter.lastName) &&
            stringFilter(r.function, filter.function);
  });
  page = 1;
  renderTable();
}

var obj, dbParam, xmlhttp, myObj, x, table = "";
obj = {};
dbParam = JSON.stringify(obj);
xmlhttp = new XMLHttpRequest();

xmlhttp.open("GET", 'https://raw.githubusercontent.com/mglabinski/beast/master/danee.json', true);
xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
xmlhttp.send("x=" + dbParam);

xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        records = JSON.parse(this.responseText);
        filteredRecords = records;
        renderTable();
        // console.log(table);
}};
</script>

</body>
</html>
