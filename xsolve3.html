<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<style>
body{
  display: table;
  margin: auto;
  text-align:center;
}
</style>
</head>

<body>
  <h2>Kingdom</h2>
  <div id="container">
<table>
  <thead>
    <tr>
      <th class="firstName">
        <a href="#" class="sort">Name</a>
      </th>
      <th class="lastName">
        <a href="#" class="sort">Surname</a>
        </th>
      <th class="dateOfBirth">
        <a href="#" class="sort">Date of Birth</a>
        </th>
      <th class="function">
        <a href="#" class="sort">Work as</a>
        </th>
      <th class="experience">
        <a href="#" class="sort">Experience</a>
        </th>
    </tr>
    <tr>
      <th class="firstName">
        <input class="filter" type="text"/>
      </th>
      <th class="lastName">
        <input class="filter" type="text"/>
      </th>
      <th></th>
      <th class="function">
        <input class="filter" type="text"/>
      </th>
      <th class="experience">
        <input class="filter" type="number" />
      </th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

  </div>
  <div class="paging">
    <a href="#" class="previous">Previous</a>
    <a href="#" class="next">Next</a>
  </div>

<script>

var dateFormat = 'DD.MM.YYYY HH:mm';

var records = [];
var filteredRecords = []; //=records (bez filtracji)
var sortKey = 'firstName';
var order = 1; // 1 - rosnąco, -1 - malejąco
var page = 1;
var rowsOnPage = 5;

var filter = {};

function getPage(records) {
  var first = (page - 1) * rowsOnPage;
  return records.slice(first, first + rowsOnPage); // wyswietlanie 0-4, 5-9 10-14
}

function renderTable() { //pojedyncze renderowanie tablicy

  var recordsToDisplay = getPage(filteredRecords);//funkcja getPage wybiera rekordy do wyświetlenia

  var table = '';
  for (x in recordsToDisplay) {
      var record = recordsToDisplay[x];
      table += "<tr><td>" +  record.firstName + "<td>" + record.lastName +"<td>" + moment(record.dateOfBirth).format(dateFormat)
      + "<td>" + record.function + "<td>" + record.experience + "</td></tr>";
  };
  $('#container tbody').html(table);//  wrzucam inner html
}


// function sortBySortKey(a, b){ //sortujemy w srodku records(json)
//   return ((a[sortKey] < b[sortKey]) ? -1 : ((a[sortKey] > b[sortKey]) ? 1:0));
// }

function sortRecords(newSortKey) {

  if (sortKey === newSortKey) {// jezeli 2 raz klikne na to samo to sie zmienia kolejnosc
    order = -order;
  }

  sortKey = newSortKey;

  records.sort(function(a, b){ //sortujemy w srodku records(json)
    var result =  ((a[sortKey] < b[sortKey]) ? -1 : ((a[sortKey] > b[sortKey]) ? 1:0));
    return result * order;// reverse sorting
  });
  renderTable();
}

$('th.firstName .sort').click(function() {
  sortRecords('firstName');
  // sortKey = 'firstName';
  // records.sort(sortBySortKey);
  // renderTable();
});

$('th.lastName .sort').click(function() {
  // sortKey = 'lastName';
  sortRecords('lastName');
});

$('th.function .sort').click(function() {
  // sortKey = 'function';
  sortRecords('function');
});

$('th.experience .sort').click(function() {
  // sortKey = 'experience';
  sortRecords('experience');
});

$('th.dateOfBirth .sort').click(function() {
  // sortKey = 'dateOfBirth';
  sortRecords('dateOfBirth');
});

$('.paging .previous').click(function() {
  if (page>1){
    page -= 1;
    renderTable();
  }
});

$('.paging .next').click(function() {
  var numberOfPages = Math.trunc((filteredRecords.length - 1) / rowsOnPage + 1);//wylicza mi liczbe stron
  if (page < numberOfPages){
    page += 1;
    renderTable();
  }
});

$('th.firstName .filter').change(function() {
  // filter.firstName = $(this).val(); //val zwraca nam aktualny input
  filterTable('firstName', $(this).val());
});

$('th.lastName .filter').change(function() {
  // filter.lastName = $(this).val(); // val zwraca nam aktualny input
  filterTable('lastName', $(this).val());
});

$('th.function .filter').change(function() {
  // filter.function = $(this).val(); //val zwraca nam aktualny input
  filterTable('function', $(this).val());
});

$('th.experience .filter').change(function() {
  // filter.experience = $(this).val(); //val zwraca nam aktualny input
  filterTable('experience', $(this).val());
});

function stringFilter(value, filterValue) {
  if (!filterValue) { //sprawdza czy jest podana wartosc formularza
    return true;
  } else {
    return value.toLowerCase().lastIndexOf(filterValue.toLowerCase(), 0) === 0; // https://www.w3schools.com/JSREF/jsref_lastindexof.asp
  }
}

function intFilter(value, filterValue) {
  if (!filterValue && filterValue != 0 || filterValue === '') { //0==false js // gdy usuwam z inputa, daje mi pusty string
    return true;
  } else {
    return value == filterValue; // nie === bo rowna sie dany typ , a == to nie
  }
}

function filterTable(newKey, newValue) {

  filter[newKey] = newValue;

  filteredRecords = records.filter(function(r) {
    return stringFilter(r.firstName, filter.firstName) &&
            stringFilter(r.lastName, filter.lastName) &&
            stringFilter(r.function, filter.function) &&
            intFilter(r.experience, filter.experience);
  });
  page = 1;
  renderTable();
}

var obj, dbParam, xmlhttp, myObj, x, table = "";
obj = {};
dbParam = JSON.stringify(obj);
xmlhttp = new XMLHttpRequest();

xmlhttp.open("GET", 'https://raw.githubusercontent.com/mglabinski/beast/master/danee.json', true);
xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
xmlhttp.send("x=" + dbParam);

xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {

        records = JSON.parse(this.responseText);
        //zmiana stringu na date(przy sortowaniu ok)
        for (i in records) {
          records[i].dateOfBirth = moment(records[i].dateOfBirth, dateFormat).toDate();//konwersja moment

          console.log(records[i].dateOfBirth);
        }

        filteredRecords = records;
        renderTable();
        // console.log(table);
  }
};
</script>

</body>
</html>
